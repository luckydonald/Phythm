	<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	 "http://www.w3.org/TR/xhtml1/DTD/Strict.dtd">
	<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
	<head>
	<meta http-equiv="content-type" content="text/html; utf-8">
	<title> May Contain Ponys.</title>
	<meta name="viewport" content="width = 420"> 
	<style>
	
	body
	{
		width:420px;
	
	}
	#infobox, #historypane
	{
		background-color: #f0f0f0;
		border-radius: 5px;
		padding: 5px;
		width:400px;
	}
	.historyelement
	{
		background-color: #e0e0e0;
		border-radius: 5px;
		padding-top: 5px;
		padding-bottom: 5px;
		padding-left:2px;
		padding-right:2px;
	}
	#bpm
	{
		font-size:3em;	
	}
	.progressbar-outer
	{
		width:300px;
		padding:2px;
		background-color:#666;
		
		//border:1px solid black;
		border-radius: 20px;
		text-align:center;
	}
	.progressbar-inner
	{
		width:0px;
		background-color:orange;
		//border:1px solid lightgreen;
		border-radius: 20px;
		
	}
	.left
	{
		float: left;
	} 
	.right
	{ 
		float: right;
	}
	.center
	{
		float: center;
	} 
	.full
	{
		left: 0;
		right: 0;
		width: 100%;
	}
	#songnotplaying
	{
		display: none;
		
	}
	#songmeta
	{
		display: block;
		margin-top: 2px;
		padding-bottom: 4px;

	}
	#songinfo
	{
		width:372px;
		padding-left: 5px;

	}
	
	.meta
	{
		border-radius: 5px;
		background-color:#cccccc;
		padding: 2px;
		margin-top:4px;
		margin-left:2px;
		clear: right;
	}
	.metafirst
	{
		border-radius: 5px 0 0 5px;
	}
	.metamiddle
	{
		border-radius: 0 0 0 0;
	}
	.metalast
	{
		border-radius: 0 5px 5px 0;
	}
	.segment
	{
		margin-top: 4px;
		padding: 2px;
		margin:2px;
	}
	.clear
	{
		display:inline-block;
		margin-top:2px;
	}
	.current td{
		background-color:orange;
	}
	
	#cover{
		height:100px;
		display:block;
		padding:5px;
		background-color:#cccccc;
		vertical-align: middle;
		border-radius: 5px;

	}
	#coverimage{
		margin-left:auto;
		margin-right:auto;
		text-align:right;
		height:100px;
		border-radius: 5px;
		display:block;
		padding: 0 auto !important;
	}
	#imageoverlay{
		text-align: center;
		display: inline;
		visibility:hidden;
		width:100%;
		height:100%;
		background-color:rgba(0,0,0,0.5);
		position: absolute;
		top:0;
		left:0;
	}
	
	.arrow-up {
		width: 0; 
		height: 0; 
		border-left: 2em solid transparent;
		border-right: 2em solid transparent;
		border-bottom: 2em solid #666;
	}
	
	.arrow-down {
		width: 0; 
		height: 0; 
		border-left: 2em solid transparent;
		border-right: 2em solid transparent;
		border-top: 2em solid #666; /* blue */
	}
	
	#bpm {
		text-align: center;
	}
	.historyid{
		text-align: right;	
	}
	
		
	</style>
	</head>
	<body>
	<script type="text/javascript">
	var update = {
		song:"",
		cover: false,
		history: false
	}
	
	function ajaxRequest(){
	 var activexmodes=["Msxml2.XMLHTTP", "Microsoft.XMLHTTP"] //activeX versions to check for in IE
	 if (window.ActiveXObject){ //Test for support for ActiveXObject in IE first (as XMLHttpRequest in IE7 is broken)
	  for (var i=0; i<activexmodes.length; i++){
	   try{
	    return new ActiveXObject(activexmodes[i])
	   }
	   catch(e){
	    //suppress error
	   }
	  }
	 }
	 else if (window.XMLHttpRequest) // if Mozilla, Safari etc
	  return new XMLHttpRequest()
	 else
	  return false
	}
	
	var mygetrequest=new ajaxRequest()
	mygetrequest.onreadystatechange=function(){
	 if (mygetrequest.readyState==4){
	  if (mygetrequest.status==200 ){ //|| window.location.href.indexOf("http")==-1
	 //var jsondata=eval("("+mygetrequest.responseText+")") //retrieve result as an JavaScript object
	   var jsondata = JSON.parse(mygetrequest.responseText);
	   applyInfos(jsondata);
	
	  }
	  else{
	   //alert("An error has occured making the request")
	  }
	 }
	}
	var globalDataArray;
	//mygetrequest.open("GET", "/cmd.json?info", true)	
	//mygetrequest.send(null)
	function $(id){
		return document.getElementById(id);
	}
	var refreshTimeout;
	
	function ajaxAction(action){
		mygetrequest.open("GET", "/cmd.json?"+action, true);
		mygetrequest.send(null);
		//dataArray = mygetrequest.dataArray;
			
		//refreshTimeout=window.Timeout(ajaxRefresh, 1000);
	}
	function applyInfos(dataArray){
		notplaying = dataArray.message.song.playingstate != 2;
		stopped = dataArray.message.song.playingstate == 0;
		var infostring =  (notplaying ? "Not Playing." : "Playing '" + dataArray.message.song.title + "' by " + dataArray.message.song.artist );
		document.title = infostring;
		
		$("bpm").innerHTML=Math.round(dataArray.message.bpm);

		if(notplaying)
		{
			$("songmeta").style.display="none";
			$("songnotplaying").style.display="block";
			if(stopped)
			{
				$("songprogress").innerHTML = "--:--";
				$("songprogress").style.width = "0px";
				$("songtotal").innerHTML = "--:--";
			}
		}
		else
		{
			$("songnotplaying").style.display="none";
			$("songmeta").style.display="block";	
		}
		$("songtitle").innerHTML = ( stopped ? "" : (dataArray.message.song.title == "" ? "&nbsp;&nbsp;-&nbsp;&nbsp;" : dataArray.message.song.title));
		$("songalbum").innerHTML = ( stopped ? "" : (dataArray.message.song.album == "" ? "&nbsp;&nbsp;-&nbsp;&nbsp;" : dataArray.message.song.album));	
		$("songartist").innerHTML = ( stopped ? "" : (dataArray.message.song.artist == "" ? "&nbsp;&nbsp;-&nbsp;&nbsp;" : dataArray.message.song.artist));	
		$("songbpm").innerHTML = ( stopped ? "0" : dataArray.message.song.bpm );
		calcBpmDiff(Math.round(dataArray.message.bpm),(stopped ? 0 : dataArray.message.song.bpm));
		var max = dataArray.message.song.totalsec;
		var curr = dataArray.message.song.currentsec;
		var progress = ((100/max)*curr);	
		//alert("( 100 / "+ max + " ) * " + curr + " = " + progress);
		var progressbar = $("songprogress");
		progresspx = Math.round(progress*3); //factor x3
		progress = Math.round(progress);
	
		
		var remaining = progresspx-(100*3)+20; //factor x3
		remaining = (remaining > 0 && remaining != Number.NaN ? remaining : 0);
		styleStr = "20px " + remaining + "px " + remaining + "px 20px";
		progresspx = (progresspx < 10 ? 10 : progresspx);
		
		progressbar.style.borderRadius=styleStr;
		progressbar.style.width=(stopped ? 0 : progresspx) + "px";
		
		progressbar.innerHTML=( stopped ? "--:--" : secondsToTomeString(curr));
		$("songtotal").innerHTML =( stopped ? "--:--" :  secondsToTomeString(max) );
		
		if (dataArray.message.update.history)
		{
			//GET HISTORY
				//  "album": "Nightcore",
				//  "artist": "Nightcore ",
				//  "bpm": 83,
				//  "currentsec": "2",
				//  "file": "/music/iTunes/Nightcore/Nightcore/01 Nightcore - Bad.mp3",
				//  "playingstate": 1,
				//  "title": "Nightcore - Bad",
				//  "totalsec": "173
			$("historypane").innerHTML = "";
			
	
			var historytable = document.createElement('table');
			historytable.setAttribute('class', 'historytable clear full');
			//historyelement.setAttribute('class', 'groupdiv');
			
			for (var i = 0; i < dataArray.message.history.length; i++) {
				var element = dataArray.message.history[i];
				// Do something with element i.
				var tr = document.createElement('tr');
				tr.setAttribute('class', (dataArray.message.history_index == i?"current":""));
	
				historytable.insertBefore(tr,historytable.childNodes[0]); //Insert as first Element
	
				//historytable.appendChild(tr); 
				
				var historyid = document.createElement('td');
				historyid.setAttribute('class', 'historyid meta metafirst ');//left center
				historyid.innerHTML = i;
				tr.appendChild(historyid);
				
				var historytitle = document.createElement('td');
				historytitle.setAttribute('class', 'historytitle meta metamiddle ');//left center
				historytitle.innerHTML = element.title;
				tr.appendChild(historytitle); 
				
				var historyalbum = document.createElement('td');
				historyalbum.setAttribute('class', 'historyalbum meta metamiddle ');//left
				historyalbum.innerHTML = element.album;
				tr.appendChild(historyalbum); 
				
				var historyartist = document.createElement('td');
				historyartist.setAttribute('class', 'historyartist meta metamiddle ');//left
				historyartist.innerHTML = element.artist;
				tr.appendChild(historyartist);
				
				var historybpm = document.createElement('td');
				historybpm.setAttribute('class', 'historybpm meta metalast ');//right
				historybpm.innerHTML = element.bpm;
				tr.appendChild(historybpm);			
			}
			$("historypane").appendChild(historytable);
			update.history=true;
		}
		//COVER ART
		if (dataArray.message.update.cover){
			//alert(dataArray.message.song.cover);
			if (dataArray.message.song.cover.indexOf("data:image/jpeg;charset=utf-8;base64,")==0)
			{
				src = dataArray.message.song.cover
			}
			else
			{
				src = "no-cover.jpg"
			}
			$("coverimage").src=src;
			$("overlayimage").src=src;

			var image = {width:0,height:0};
			var screen = {width:0,height:0};
		//	//alert(window.getComputedStyle($("coverimage")).width);
		//	screen.width = window.getComputedStyle($("imageoverlay")).width;
		//	screen.height = window.getComputedStyle($("imageoverlay")).height;
		//	image.width = window.getComputedStyle($("overlayimage")).width;
		//	image.height = window.getComputedStyle($("overlayimage")).height;
		//	cover.width = window.getComputedStyle($("coverimage")).width;
		//	cover.height = window.getComputedStyle($("coverimage")).height;
		//	screen.width = ( screen.width.indexOf("px")==-1 ? screen.width : screen.width.substring(0,screen.width.length - 2 ) ); 
		//	screen.height = ( screen.height.indexOf("px")==-1 ? screen.height : screen.height.substring(0,screen.height.length - 2 ) ); 
		//	image.width = ( image.width.indexOf("px")==-1 ? image.width : image.width.substring(0,image.width.length - 2 ) ); 
		//	image.height = ( image.height.indexOf("px")==-1 ? image.height : image.height.substring(0,image.height.length - 2 ) ); 
		//	var oldImage = image;
		//	var ratioA =  cover.width / cover.height;
		//	var ratioB = cover.height / cover.width;	

		//	//alert(image.width + " > " + screen.width + "\n" + image.height + " > " + screen.height + "\n" + image.width + " / " + image.height + " = " + ratioA );

		//	if(image.width > screen.width)
		//	{
		//
		//		image.width = screen.width;
		//		image.height = screen.width * ratioA;
		//	}
		//	//alert(image.width + " > " + screen.width + "\n" + image.height + " > " + screen.height + "\n" + image.width + " / " + image.height + " = " + ratioA );

		//	if(image.height > screen.height)
		//	{
		//		image.height = screen.height;
		//		image.width = screen.height * ratioB;
		//	}
		//	//alert(image.width + " > " + screen.width + "\n" + image.height + " > " + screen.height + "\n" + image.width + " / " + image.height + " = " + ratioA );

		//	//$("overlayimage").style.height = (wndsize().width) + "px";
		//	//$("overlayimage").style.width = (wndsize().height) + "px";
		//	$("overlayimage").style.height = (image.width) + "px";
		//	$("overlayimage").style.width = (image.height) + "px";
		//	
		//	//var image = new PNG(dataArray.message.song.cover);
		//	//$("cover").style.background="url(" + dataArray.message.song.cover + ") center center no-repeat";
		//	
		//	//$("coverimage").reload();
			update.cover=true;	
		}
		if (update.song != dataArray.message.song.file)
		{
			ajaxAction("fullupdate");
		}
		if (update.cover == true && update.history == true)
		{
			update.song = dataArray.message.song.file;
			update.cover == false;
			update.history == false;
		}
	}

	function secondsToTomeString(seconds){
		var dateObj = new Date(seconds*1000);
		return ( dateObj.getHours()<1 ? dateObj.getHours()+":" : "" ) + ( dateObj.getMinutes()<10 ? "0" : "") + dateObj.getMinutes() + ":" + (dateObj.getSeconds()<10 ? "0" : "") + dateObj.getSeconds() 
	}
	
	function refreshInfos(){
		ajaxAction("info");
		timeout = window.setTimeout("refreshInfos()", 1000);
	}
	var timeout = window.setTimeout("refreshInfos()", 1000);
	
	function zoomImage() {
		$("imageoverlay").style.visibility = "visible";//"inline";
		
		
	}
	function dezoomImage() {
		$("imageoverlay").style.visibility = "hidden";
		
		
	}
	function calcBpmDiff(realbpm, songbpm){
		if(songbpm == 0){
			$("bpmarrowup").style.borderBottomColor = "#f00";
			$("bpmarrowdown").style.borderTopColor = "#0f0";
			return;
		}
		if (realbpm == songbpm){
			$("bpm").style.color="#6f6";
			$("bpmarrowup").style.borderBottomColor = "#666";
			$("bpmarrowdown").style.borderTopColor = "#666";
		}else{
			$("bpm").style.color="#000";
			if (realbpm < songbpm) {
				$("bpmarrowup").style.borderBottomColor = "#f00";
				$("bpmarrowdown").style.borderTopColor = "#666";
			} else if (realbpm > songbpm) {
				$("bpmarrowup").style.borderBottomColor = "#666";
				$("bpmarrowdown").style.borderTopColor = "#0f0";
			}
		}
			
	}

	function wndsize(){
		var w = 0;var h = 0;
		//IE
		if(!window.innerWidth){
		    if(!(document.documentElement.clientWidth == 0)){
			//strict mode
			w = document.documentElement.clientWidth;h = document.documentElement.clientHeight;
		    } else{
			//quirks mode
			w = document.body.clientWidth;h = document.body.clientHeight;
		    }
		} else {
		    //w3c
		    w = window.innerWidth;h = window.innerHeight;
		}
		return {width:w,height:h};
	}
</script>
	<div id="imageoverlay" onclick="dezoomImage()"><img id="overlayimage" onclick="dezoomImage()" scr="" /></div>
	<div id="infobox" class="clear">
		<div id="first_row">
			<div id="cover" class="clear">
				<img id="coverimage" onclick="zoomImage()" scr="" />
			</div>
			<div id="rightinfo">
				<div id="songinfo" class="songinfo">
					<div id="songmeta">
						<div id="songtitle" class="meta full">Unknown Title</div> <div id="songalbum" class="meta left">Unknown Album</div><div id="songartist" class="meta left">Unknown Artist</div><div id="songbpm" class="meta right">0 BPM</div>		
					</div>
					<div id="songnotplaying">
						<div class="meta">Not Playing.</div>
					</div>
				</div>
				<br class="clear">
				<div id="progressbar" class="segment">
					<div class="progressbar-outer" style="display:inline-block;">
						<div class="progressbar-inner left" id="songprogress">--:--</div>
					</div>
					<div id="songtotal" class="right" style="display:inline-block;">--:--</div>
				</div>
			</div>
		</div>
		<br class="clear">
		<div id="second_row" class="segment">
			<div id="controls" class="left">
				<div id="upper_controls">
					<input id="prev" type="button" value="&#9665;" onclick='ajaxAction("playlast")'/>
					<input id="playpause" type="button" value="&#65517;&nbsp;&#9658;" onclick='ajaxAction("playpause")'/>
					<input id="next" type="button" onclick='ajaxAction("playnext")' value="&#9655;" />
				</div>
				<div id="lower_controls">
					<input type="button" onclick='ajaxAction("fullupdate")' value="&reg;"/>
					<input type="button" onclick='ajaxAction("forcenext")' value="Force Next"/>
				</div>
			</div>
			<div id="stats" class="right">
				<div class="inline left"  style="display:inline-block; text-align: center;">
					<div id="bpmarrowup" class="arrow-up" style="display:inline-block; position: relative;"></div>
					<div id="bpm" class="meta" style="text-align: center">---</div>
					<div style=" position: relative;top: -1em;">BPM</div>
					<div style="position: relative;top: -0.5em;display:inline-block;"id="bpmarrowdown" class="arrow-down"></div>
				</div>

			</div>
		</div>
	</div>

	<div id="historypane">
		
		
	</div>
	<br>
	<br>
	<br>
	<br>
	<hr>
	The Pinkie Pie Is A Lie! 
	</body>
	</html>
